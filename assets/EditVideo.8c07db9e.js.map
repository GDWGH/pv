{"version":3,"file":"EditVideo.8c07db9e.js","sources":["../../packages/video/EditVideo.vue"],"sourcesContent":["<template>\n  <template v-if=\"video\">\n    <div class=\"mx-2\">\n      <div class=\"pl-2 text-gray-700 dark:text-gray-200 border-b border-purple-200 dark:border-gray-700\">\n        {{ t('video.edit-video.profile.profile') }}\n      </div>\n      <div class=\"mx-2 mt-1\">\n        <div class=\"flex flex-col gap-2\">\n          <div class=\"flex\">\n            <span>{{ t('video.edit-video.profile.title') }}</span><span class=\"ml-4 border-b border-purple-300 dark:border-gray-600\" v-text=\"video.item.title\" />\n          </div>\n          <div class=\"flex\">\n            <span>{{ t('video.edit-video.profile.ranks.rank') }}</span>\n            <template v-if=\"auth.isAdmin\">\n              <PvSelect v-model=\"clearence\" class=\"ml-4 w-52\" :item-list=\"clearences\" />\n            </template>\n            <template v-else>\n              <span\n                class=\"ml-4 border-b border-purple-400 dark:border-purple-800\"\n                v-text=\"clearences[Number(clearence)].name\"\n              />\n            </template>\n          </div>\n        </div>\n      </div>\n    </div>\n  </template>\n</template>\n\n<script lang=\"ts\" setup>\nimport { computed, ref, watch, watchEffect } from 'vue'\nimport { useRoute } from 'vue-router'\nimport { useI18n } from 'vue-i18n'\nimport { useTimeoutFn } from '@vueuse/core'\nimport PvSelect from '@/ui/components/PvSelect.vue'\nimport { gql, useMutation, useQuery, useResult } from '@/graphql'\nimport type { Mutation, Query } from '@/graphql'\nimport { setSiteTitle } from '@/common/libs/setSiteTitle'\nimport { useAuth } from '@/user'\nimport { startProgress, stopProgress } from '@/nprogress'\n\nconst { t } = useI18n()\nconst route = useRoute()\nconst auth = useAuth()\n\n/* submit query */\nconst vid = computed(() => route.params.vid as string)\nconst { result, loading, refetch } = useQuery<Query>(\n  gql`\n    query ($vid: String!) {\n      getVideo(para: { vid: $vid, lang: \"CHS\" }) {\n        item {\n          title\n          desc\n          uploadTime\n          url\n          repostType\n        }\n        meta {\n          createdBy {\n            id\n            username\n            desc\n            image\n            gravatar\n          }\n        }\n        clearence\n      }\n    }\n  `,\n  {\n    vid: vid.value,\n  },\n)\n\n// sync process bar\nwatchEffect(() => {\n  if (loading.value)\n    startProgress()\n  else\n    stopProgress()\n})\n\n/* basic info */\nconst video = useResult(result, null, data => data?.getVideo)\n// change title\nwatchEffect(() => {\n  if (video.value)\n    setSiteTitle(t('video.edit-video.title', { videoname: video.value.item.title }))\n})\n\nconst clearence = ref('3')\nconst clearences = computed(() => [\n  {\n    name: t('video.edit-video.profile.ranks.0'),\n    value: '0',\n  },\n  {\n    name: t('video.edit-video.profile.ranks.1'),\n    value: '1',\n  },\n  {\n    name: t('video.edit-video.profile.ranks.2'),\n    value: '2',\n  },\n  {\n    name: t('video.edit-video.profile.ranks.3'),\n    value: '3',\n  },\n])\nwatchEffect(() => {\n  if (video.value)\n    clearence.value = video.value.clearence.toString()\n})\n\nconst loadingMutateClearence = ref(false)\nconst saving = computed(() => loadingMutateClearence.value)\nconst savingFailed = ref(false)\n{\n  const { mutate } = useMutation<Mutation>(\n    gql`\n      mutation ($clearence: Int!, $vid: String!) {\n        setVideoClearence(para: { clearence: $clearence, vid: $vid })\n      }\n    `,\n  )\n  watch(clearence, (v, o) => {\n    if (v !== o && v !== video.value?.clearence.toString()) {\n      loadingMutateClearence.value = true\n      mutate({\n        vid: vid.value,\n        clearence: Number(clearence.value),\n      })\n        .then(() => {\n          loadingMutateClearence.value = false\n          refetch()\n        })\n        .catch((e) => {\n          // console.log(e)\n          savingFailed.value = true\n          loadingMutateClearence.value = false\n        })\n    }\n  })\n}\nwatchEffect(() => {\n  if (saving.value && video.value) {\n    setSiteTitle(t('video.edit-video.profile.edit.saving', { videoname: video.value.item.title }))\n    const stop = watchEffect(() => {\n      if (!saving.value && video.value) {\n        stop()\n        if (!savingFailed.value) {\n          setSiteTitle(t('video.edit-video.profile.edit.saved', { videoname: video.value.item.title }))\n          useTimeoutFn(() => {\n            if (video.value)\n              setSiteTitle(t('video.edit-video.title', { videoname: video.value.item.title }))\n          }, 3000)\n        }\n        else {\n          setSiteTitle(t('video.edit-video.profile.edit.failed', { videoname: video.value.item.title }))\n        }\n        savingFailed.value = false\n      }\n    })\n  }\n})\n</script>\n"],"names":["useI18n","route","useRoute","auth","useAuth","vid","computed","result","loading","refetch","useQuery","gql","watchEffect","startProgress","stopProgress","video","useResult","data","setSiteTitle","clearence","ref","clearences","loadingMutateClearence","saving","savingFailed","mutate","useMutation","watch","v","o","_a","e","stop","useTimeoutFn"],"mappings":"2qBAyCA,KAAA,CAAA,GAAAA,IACAC,EAAAC,IACAC,EAAAC,IAGAC,EAAAC,EAAA,IAAAL,EAAA,OAAA,GAAA,EACA,CAAA,OAAAM,EAAA,QAAAC,EAAA,QAAAC,CAAA,EAAAC,EAAqCC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IACnC,CAuBA,IAAAN,EAAA,KACW,CACX,EAIFO,EAAA,IAAA,CACEJ,EAAA,MACEK,IAEAC,GAAa,CAAA,EAIjB,MAAAC,EAAAC,EAAAT,EAAA,KAAAU,GAAAA,GAAA,YAAAA,EAAA,QAAA,EAEAL,EAAA,IAAA,CACEG,EAAA,OACEG,EAAA,EAAA,yBAAA,CAAA,UAAAH,EAAA,MAAA,KAAA,KAAA,CAAA,CAAA,CAA+E,CAAA,EAGnF,MAAAI,EAAAC,EAAA,GAAA,EACAC,EAAAf,EAAA,IAAA,CAAkC,CAChC,KAAA,EAAA,kCAAA,EAC4C,MAAA,GACnC,EACT,CACA,KAAA,EAAA,kCAAA,EAC4C,MAAA,GACnC,EACT,CACA,KAAA,EAAA,kCAAA,EAC4C,MAAA,GACnC,EACT,CACA,KAAA,EAAA,kCAAA,EAC4C,MAAA,GACnC,CACT,CAAA,EAEFM,EAAA,IAAA,CACEG,EAAA,QACEI,EAAA,MAAAJ,EAAA,MAAA,UAAA,SAAA,EAAiD,CAAA,EAGrD,MAAAO,EAAAF,EAAA,EAAA,EACAG,EAAAjB,EAAA,IAAAgB,EAAA,KAAA,EACAE,EAAAJ,EAAA,EAAA,EACA,CACE,KAAA,CAAA,OAAAK,CAAA,EAAAC,EAAmBf;AAAA;AAAA;AAAA;AAAA,KACjB,EAMFgB,EAAAR,EAAA,CAAAS,EAAAC,IAAA,OACED,IAAAC,GAAAD,MAAAE,EAAAf,EAAA,QAAA,YAAAe,EAAA,UAAA,cACER,EAAA,MAAA,GACAG,EAAA,CAAO,IAAApB,EAAA,MACI,UAAA,OAAAc,EAAA,KAAA,CACwB,CAAA,EAAA,KAAA,IAAA,CAG/BG,EAAA,MAAA,GACAb,GAAQ,CAAA,EAAA,MAAAsB,GAAA,CAIRP,EAAA,MAAA,GACAF,EAAA,MAAA,EAA+B,CAAA,EAErC,CAAA,CACD,CAEH,OAAAV,EAAA,IAAA,CACE,GAAAW,EAAA,OAAAR,EAAA,MAAA,CACEG,EAAA,EAAA,uCAAA,CAAA,UAAAH,EAAA,MAAA,KAAA,KAAA,CAAA,CAAA,EACA,MAAAiB,EAAApB,EAAA,IAAA,CACE,CAAAW,EAAA,OAAAR,EAAA,QACEiB,IACAR,EAAA,MAQEN,EAAA,EAAA,uCAAA,CAAA,UAAAH,EAAA,MAAA,KAAA,KAAA,CAAA,CAAA,GAPAG,EAAA,EAAA,sCAAA,CAAA,UAAAH,EAAA,MAAA,KAAA,KAAA,CAAA,CAAA,EACAkB,EAAA,IAAA,CACElB,EAAA,OACEG,EAAA,EAAA,yBAAA,CAAA,UAAAH,EAAA,MAAA,KAAA,KAAA,CAAA,CAAA,CAA+E,EAAA,GAAA,GAMrFS,EAAA,MAAA,GACF,CAAA,CACD,CACH,CAAA"}